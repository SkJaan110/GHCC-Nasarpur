<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SKScoringCric — Tournament Scorer</title>
<style>
  /* ---------------- Basic theme ---------------- */
  :root{
    --bg1:#071124; --bg2:#0f2b44; --accent:#ffb020; --card:rgba(255,255,255,0.03);
    --muted: rgba(255,255,255,0.75);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Arial,Helvetica;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;min-height:100vh}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(0,0,0,0.18)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:46px;height:46px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#000;font-weight:900}
  h1{margin:0;font-size:18px;color:#000;background:var(--accent);padding:6px 10px;border-radius:8px}
  nav{display:flex;gap:8px}
  nav button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer}
  nav button.active{background:var(--accent);color:#000;border-color:var(--accent)}
  main{max-width:1100px;margin:14px auto;padding:12px}
  .card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px}
  .muted{color:var(--muted);font-size:13px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:#fff;margin:6px 0}
  .btn{display:inline-block;padding:10px 12px;border-radius:8px;border:0;background:#26313b;color:#fff;cursor:pointer;margin:6px 4px}
  .btn.primary{background:var(--accent);color:#000;font-weight:700}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:220px}
  /* ---------- Views ---------- */
  .view{display:none}
  .view.active{display:block}
  /* ---------- Tournament list ---------- */
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin:8px 0}
  .small{font-size:13px}
  /* ---------- scoring UI ---------- */
  .score-top{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .live-summary{display:flex;align-items:center;gap:14px}
  .team-short{background:#111;padding:8px;border-radius:6px;font-weight:800}
  .big{font-size:30px;font-weight:800}
  .players-mini{display:flex;flex-direction:column;gap:8px}
  .recent-balls{display:flex;gap:6px;flex-wrap:wrap}
  .recent-balls .ball{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04);font-weight:700;color:#fff}
  .controls{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .runs{display:flex;gap:8px;flex-wrap:wrap}
  .runs button{padding:12px 16px;border-radius:8px;border:0;background:#ffffff;color:#000;font-weight:700}
  .extras{display:flex;gap:8px;flex-wrap:wrap}
  .extras button{padding:10px 12px;border-radius:8px;border:0;background:#ffeb3b;color:#000;font-weight:700}
  .wicket-btn{background:#e74c3c;color:#fff;padding:10px 14px;border-radius:8px;border:0}
  .tab-row{display:flex;gap:8px;margin-top:12px}
  .tab-row button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
  .tab-row button.active{background:var(--accent);color:#000;border-color:var(--accent)}
  .score-line{width:100%;border-collapse:collapse;margin-top:12px}
  .score-line th,.score-line td{padding:8px;border:1px solid rgba(255,255,255,0.03);text-align:left;color:#fff}
  /* modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
  .modal{width:100%;max-width:640px;background:linear-gradient(180deg,#0b2545,#071124);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  .modal h3{margin:0 0 8px}
  .hidden{display:none}
  /* responsive */
  @media(max-width:900px){
    .row{flex-direction:column}
    .live-summary{flex-direction:column;align-items:flex-start;gap:6px}
    .recent-balls .ball{width:28px;height:28px}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">SK</div>
    <h1>SKScoringCric</h1>
  </div>
  <nav id="mainNav">
    <button data-view="home" class="active">Home</button>
    <button data-view="tournaments">Tournaments</button>
    <button data-view="matches">Matches</button>
    <button data-view="scoring">Scoring</button>
  </nav>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="view active">
    <div class="card">
      <h2>Welcome — Create Tournament</h2>
      <p class="muted">Start by creating a tournament. After creating, open it and add teams, players and matches.</p>
      <div class="row">
        <div class="col">
          <input id="newTournamentName" placeholder="Tournament name (e.g. GHCC Nasarpur)" />
          <button class="btn primary" id="createTournamentBtn">Create Tournament</button>
        </div>
        <div class="col">
          <div class="muted">Existing tournaments:</div>
          <div id="tournamentList"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- TOURNAMENT DETAIL -->
  <section id="tournaments" class="view">
    <div class="card">
      <div class="row">
        <div class="col">
          <h3 id="tTitle">Tournament</h3>
          <div class="muted" id="tSubtitle">Open a tournament to manage teams & matches</div>
        </div>
        <div class="col" style="flex:0 0 300px">
          <button class="btn" id="backToHome">Back</button>
          <button class="btn primary" id="addTeamBtn">Create Team</button>
        </div>
      </div>
      <div id="teamList" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- MATCHES -->
  <section id="matches" class="view">
    <div class="card">
      <div class="row">
        <div class="col">
          <h3>Matches</h3>
          <div class="muted">Create matches for selected tournament</div>
          <div style="margin-top:8px">
            <label>Choose Tournament</label>
            <select id="matchTournamentSelect"></select>
            <label>Team A</label>
            <select id="teamASelect"></select>
            <label>Team B</label>
            <select id="teamBSelect"></select>
            <label>Overs per innings</label>
            <input id="matchOvers" type="number" min="1" value="5" />
            <button class="btn primary" id="createMatchBtn">Create Match</button>
          </div>
        </div>
        <div class="col">
          <h4>Scheduled Matches</h4>
          <div id="matchList"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- SCORING (single page view) -->
  <section id="scoring" class="view">
    <div class="card">
      <div class="row score-top">
        <div class="left col">
          <div id="tossInfo" class="muted small">Toss: -</div>
          <div id="matchHeadline" class="headline">No match</div>
          <div class="live-summary">
            <div class="team-short" id="teamShort">--</div>
            <div class="big" id="liveScore">0/0</div>
            <div class="muted" id="oversText">0.0</div>
            <div class="muted" id="targetText"></div>
          </div>
          <div class="muted small" id="needText"></div>
        </div>
        <div class="right col" style="flex:0 0 300px">
          <div class="players-mini">
            <div><b>On Strike</b><div id="strikeName">-</div></div>
            <div><b>Non Strike</b><div id="nonStrikeName">-</div></div>
            <div><b>Bowler</b><div id="bowlerName">-</div></div>
          </div>
          <div style="margin-top:8px"><b>Recent</b></div>
          <div class="recent-balls" id="recentBalls"></div>
        </div>
      </div>

      <div class="controls">
        <div class="runs">
          <button data-run="0" class="runBtn">0</button>
          <button data-run="1" class="runBtn">1</button>
          <button data-run="2" class="runBtn">2</button>
          <button data-run="3" class="runBtn">3</button>
          <button data-run="4" class="runBtn">4</button>
          <button data-run="6" class="runBtn">6</button>
        </div>
        <div class="extras">
          <button data-extra="wd" class="extraBtn">Wide</button>
          <button data-extra="nb" class="extraBtn">No Ball</button>
          <button data-extra="bye" class="extraBtn">Bye</button>
          <button data-extra="lbye" class="extraBtn">Leg Bye</button>
          <button id="undoBtn" class="btn">Undo</button>
        </div>
        <div style="margin-top:8px">
          <button id="wicketBtn" class="wicket-btn">Wicket</button>
          <button id="changeBowlerBtn" class="btn">Change Bowler</button>
        </div>
      </div>

      <div class="tab-row">
        <button data-tab="scorecard" class="tab active">Scorecard</button>
        <button data-tab="bowling" class="tab">Bowling</button>
        <button data-tab="info" class="tab">Info</button>
        <button data-tab="commentary" class="tab">Commentary</button>
      </div>

      <div id="tabContent">
        <div id="scorecard" class="card" style="margin-top:12px">
          <table class="score-line">
            <thead><tr><th>Team</th><th>Score</th><th>Batsman</th><th>R</th><th>B</th><th>Bowler</th><th>R/W</th><th>O</th></tr></thead>
            <tbody>
              <tr>
                <td id="shortTeam">--</td><td id="scoreLine">0/0</td><td id="batLine">-</td><td id="batR">0</td><td id="batB">0</td><td id="bowLine">-</td><td id="bowRW">0/0</td><td id="bowO">0.0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="bowling" class="card" style="margin-top:12px;display:none">
          <h4>Bowling Figures</h4>
          <table id="bowlingTable" class="score-table"><thead><tr><th>Bowler</th><th>O</th><th>R</th><th>W</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="info" class="card" style="margin-top:12px;display:none">
          <h4>Match Info</h4>
          <div id="infoBox" class="muted">No info</div>
        </div>

        <div id="commentary" class="card" style="margin-top:12px;display:none">
          <h4>Commentary</h4>
          <pre id="commBox" class="muted" style="white-space:pre-wrap"></pre>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modals -->
<div id="modal" class="modal-overlay">
  <div class="modal" id="modalContent"></div>
</div>

<script>
/* ----------------- Single-file SPA with scoring ----------------- */
/* Data model in localStorage under key 'skscoring_data' */
(function(){
  const STORAGE_KEY = 'skscoring_data_v1';

  // DOM refs
  const views = document.querySelectorAll('.view');
  const navBtns = document.querySelectorAll('nav button');
  const tournamentListEl = document.getElementById('tournamentList');
  const createTournamentBtn = document.getElementById('createTournamentBtn');
  const newTournamentName = document.getElementById('newTournamentName');

  const tournamentsView = document.getElementById('tournaments');
  const tTitle = document.getElementById('tTitle');
  const tSubtitle = document.getElementById('tSubtitle');
  const teamListEl = document.getElementById('teamList');
  const backToHome = document.getElementById('backToHome');
  const addTeamBtn = document.getElementById('addTeamBtn');

  const matchTournamentSelect = document.getElementById('matchTournamentSelect');
  const teamASelect = document.getElementById('teamASelect');
  const teamBSelect = document.getElementById('teamBSelect');
  const matchOvers = document.getElementById('matchOvers');
  const createMatchBtn = document.getElementById('createMatchBtn');
  const matchListEl = document.getElementById('matchList');

  const scoringView = document.getElementById('scoring');
  const matchHeadline = document.getElementById('matchHeadline');
  const tossInfo = document.getElementById('tossInfo');
  const teamShort = document.getElementById('teamShort');
  const liveScore = document.getElementById('liveScore');
  const oversText = document.getElementById('oversText');
  const targetText = document.getElementById('targetText');
  const needText = document.getElementById('needText');
  const strikeNameEl = document.getElementById('strikeName');
  const nonStrikeNameEl = document.getElementById('nonStrikeName');
  const bowlerNameEl = document.getElementById('bowlerName');
  const recentBallsEl = document.getElementById('recentBalls');

  const runBtns = document.querySelectorAll('.runBtn');
  const extraBtns = document.querySelectorAll('.extraBtn');
  const undoBtn = document.getElementById('undoBtn');
  const wicketBtn = document.getElementById('wicketBtn');
  const changeBowlerBtn = document.getElementById('changeBowlerBtn');

  const tabs = document.querySelectorAll('.tab-row button');
  const tabMap = {scorecard:document.getElementById('scorecard'), bowling:document.getElementById('bowling'), info:document.getElementById('info'), commentary:document.getElementById('commentary')};

  const scoreLineEls = {
    shortTeam: document.getElementById('shortTeam'),
    scoreLine: document.getElementById('scoreLine'),
    batLine: document.getElementById('batLine'),
    batR: document.getElementById('batR'),
    batB: document.getElementById('batB'),
    bowLine: document.getElementById('bowLine'),
    bowRW: document.getElementById('bowRW'),
    bowO: document.getElementById('bowO'),
    bowlingTable: document.querySelector('#bowlingTable tbody'),
    commBox: document.getElementById('commBox'),
  };

  // in-memory active match runtime
  let data = loadData();
  let currentTournamentId = null;
  let activeMatchRuntime = null; // holds the live scoring object
  let historyStack = [];

  // ---------- Navigation ----------
  function showView(name){
    views.forEach(v=>v.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    navBtns.forEach(b=>b.classList.toggle('active', b.dataset.view===name));
  }
  document.querySelectorAll('nav button').forEach(b=> b.addEventListener('click', ()=> showView(b.dataset.view)));

  // ---------- Storage ----------
  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    const base = { tournaments: [], nextId: 1 };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
    return base;
  }
  function saveData(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  // ---------- Helper: ID ----------
  function newid(prefix='id'){
    const id = `${prefix}_${data.nextId++}`;
    saveData();
    return id;
  }

  // ---------- HOME: list tournaments ----------
  function renderTournamentList(){
    tournamentListEl.innerHTML = '';
    data.tournaments.forEach(t=>{
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `<div><strong>${escapeHtml(t.name)}</strong><div class="muted small">${t.teams.length} teams • ${t.matches.length} matches</div></div>
        <div>
          <button class="btn" onclick="openTournament('${t.id}')">Open</button>
          <button class="btn" onclick="deleteTournament('${t.id}')">Delete</button>
        </div>`;
      tournamentListEl.appendChild(div);
    });
  }

  // create tournament
  createTournamentBtn.addEventListener('click', ()=>{
    const name = newTournamentName.value.trim();
    if(!name) return alert('Enter tournament name');
    const t = { id: newid('t'), name, teams: [], matches: [] };
    data.tournaments.push(t);
    saveData();
    newTournamentName.value='';
    renderTournamentList();
    populateMatchTournamentSelect();
    alert('Tournament created. Click Open to manage it.');
  });

  // accessible from inline onclick in DOM (exposed)
  window.openTournament = function(tid){
    currentTournamentId = tid;
    const t = data.tournaments.find(x=>x.id===tid);
    if(!t) return alert('Tournament not found');
    tTitle.innerText = t.name;
    tSubtitle.innerText = `${t.teams.length} teams • ${t.matches.length} matches`;
    renderTeamList(t);
    showView('tournaments');
  };

  window.deleteTournament = function(tid){
    if(!confirm('Delete this tournament?')) return;
    data.tournaments = data.tournaments.filter(x=>x.id!==tid);
    saveData();
    renderTournamentList();
    populateMatchTournamentSelect();
  };

  backToHome.addEventListener('click', ()=> showView('home'));

  // ---------- Teams ----------
  addTeamBtn.addEventListener('click', ()=>{
    const name = prompt('Team name:');
    if(!name) return;
    const short = prompt('Team short code (2-3 letters, e.g. GH):', name.slice(0,2).toUpperCase()) || name.slice(0,2).toUpperCase();
    const tdata = data.tournaments.find(x=>x.id===currentTournamentId);
    if(!tdata) return alert('Open a tournament first');
    const team = { id: newid('team'), name, short, players: [] };
    tdata.teams.push(team);
    saveData();
    renderTeamList(tdata);
    populateMatchTournamentSelect();
  });

  function renderTeamList(t){
    teamListEl.innerHTML = '';
    t.teams.forEach(team=>{
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `<div>
        <strong>${escapeHtml(team.name)} (${team.short})</strong>
        <div class="muted small">${team.players.length} players</div>
        </div>
        <div>
          <button class="btn" onclick="openTeam('${t.id}','${team.id}')">Open</button>
          <button class="btn" onclick="deleteTeam('${t.id}','${team.id}')">Delete</button>
        </div>`;
      teamListEl.appendChild(div);
    });
  }

  window.deleteTeam = function(tid, teamId){
    if(!confirm('Delete this team?')) return;
    const t = data.tournaments.find(x=>x.id===tid);
    if(!t) return;
    t.teams = t.teams.filter(x=>x.id!==teamId);
    saveData();
    renderTeamList(t);
    populateMatchTournamentSelect();
  };

  // ---------- Team page (players) ----------
  window.openTeam = function(tid, teamId){
    const t = data.tournaments.find(x=>x.id===tid);
    if(!t) return alert('Tournament not found');
    const team = t.teams.find(x=>x.id===teamId);
    if(!team) return alert('Team not found');
    // show a modal to manage players (simple)
    showModal(`<h3>${escapeHtml(team.name)} — Players</h3>
      <div id="playerBox">${team.players.map((p,i)=>`<div style="padding:6px;background:rgba(255,255,255,0.02);margin:6px 0;border-radius:6px;">${escapeHtml(p.name)} <button onclick="editPlayer('${tid}','${teamId}','${p.id}')">Edit</button> <button onclick="deletePlayer('${tid}','${teamId}','${p.id}')">Delete</button></div>`).join('')}</div>
      <div style="margin-top:8px">
      <input id="newPlayerName" placeholder="Player name"/><br/>
      <select id="newPlayerRole"><option value="batsman">Batsman</option><option value="bowler">Bowler</option><option value="allrounder">All-rounder</option><option value="wk">Wicket-keeper</option></select>
      <div style="margin-top:8px"><button id="addPlayerToTeamBtn" class="btn primary">Add Player</button> <button id="closeModalBtn" class="btn">Close</button></div>
      </div>`);
    document.getElementById('closeModalBtn').addEventListener('click', hideModal);
    document.getElementById('addPlayerToTeamBtn').addEventListener('click', ()=>{
      const name = document.getElementById('newPlayerName').value.trim();
      const role = document.getElementById('newPlayerRole').value;
      if(!name) return alert('Enter player name');
      const p = { id:newid('p'), name, role, status:'not out' };
      team.players.push(p);
      saveData();
      hideModal();
      openTeam(tid, teamId);
    });
  };

  window.editPlayer = function(tid, teamId, pid){
    const t = data.tournaments.find(x=>x.id===tid);
    const team = t.teams.find(x=>x.id===teamId);
    const p = team.players.find(x=>x.id===pid);
    const nn = prompt('Edit player name', p.name);
    if(!nn) return;
    p.name = nn;
    saveData();
    openTeam(tid, teamId);
  };

  window.deletePlayer = function(tid, teamId, pid){
    if(!confirm('Delete player?')) return;
    const t = data.tournaments.find(x=>x.id===tid);
    const team = t.teams.find(x=>x.id===teamId);
    team.players = team.players.filter(x=>x.id!==pid);
    saveData();
    openTeam(tid, teamId);
  };

  // ---------- Matches (create & list) ----------
  function populateMatchTournamentSelect(){
    matchTournamentSelect.innerHTML = data.tournaments.map(t=>`<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
    // also update match tournament for matches view
    renderMatchList();
  }
  function populateTeamSelects(tid){
    const t = data.tournaments.find(x=>x.id===tid);
    if(!t) return;
    teamASelect.innerHTML = t.teams.map(team=>`<option value="${team.id}">${escapeHtml(team.name)}</option>`).join('');
    teamBSelect.innerHTML = t.teams.map(team=>`<option value="${team.id}">${escapeHtml(team.name)}</option>`).join('');
  }
  matchTournamentSelect.addEventListener('change', ()=> populateTeamSelects(matchTournamentSelect.value));
  createMatchBtn.addEventListener('click', ()=>{
    const tid = matchTournamentSelect.value;
    const t = data.tournaments.find(x=>x.id===tid);
    if(!t) return alert('Select tournament');
    const a = teamASelect.value, b = teamBSelect.value;
    if(a===b) return alert('Choose two different teams');
    const overs = parseInt(matchOvers.value) || 5;
    const m = { id:newid('m'), teamA:a, teamB:b, overs:overs, date: (new Date()).toISOString(), status:'scheduled', runtime:null };
    t.matches.push(m);
    saveData();
    renderMatchList();
    alert('Match created in tournament');
  });

  function renderMatchList(){
    matchListEl.innerHTML = '';
    data.tournaments.forEach(t=>{
      t.matches.forEach(m=>{
        const ta = t.teams.find(x=>x.id===m.teamA) || {name:'-'};
        const tb = t.teams.find(x=>x.id===m.teamB) || {name:'-'};
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `<div><strong>${escapeHtml(t.name)}: ${escapeHtml(ta.name)} vs ${escapeHtml(tb.name)}</strong><div class="muted small">${m.overs} overs • ${m.status}</div></div>
          <div>
            <button class="btn" onclick="startMatch('${t.id}','${m.id}')">Start</button>
            <button class="btn" onclick="openMatch('${t.id}','${m.id}')">Open</button>
          </div>`;
        matchListEl.appendChild(div);
      });
    });
  }

  // ---------- Start match: toss modal and opening selection ----------
  window.startMatch = function(tid, mid){
    const t = data.tournaments.find(x=>x.id===tid);
    if(!t) return alert('Tournament not found');
    const m = t.matches.find(x=>x.id===mid);
    if(!m) return alert('Match not found');
    // toss modal
    showModal(`<h3>Toss</h3>
      <div><label>Toss winner</label><select id="tossSel">${t.teams.map(team=>`<option value="${team.id}">${escapeHtml(team.name)}</option>`).join('')}</select></div>
      <div><label>Choose</label><select id="tossOpt"><option value="bat">Bat</option><option value="bowl">Bowl</option></select></div>
      <div style="margin-top:10px"><button id="applyToss" class="btn primary">Apply</button> <button id="cancelToss" class="btn">Cancel</button></div>`);
    document.getElementById('cancelToss').addEventListener('click', hideModal);
    document.getElementById('applyToss').addEventListener('click', ()=>{
      const tossWinner = document.getElementById('tossSel').value;
      const tossOpt = document.getElementById('tossOpt').value;
      hideModal();
      // now opening selector
      showOpeningSelector(tid, mid, tossWinner, tossOpt);
    }, {once:true});
  };

  function showOpeningSelector(tid, mid, tossWinnerId, tossOpt){
    const t = data.tournaments.find(x=>x.id===tid);
    const m = t.matches.find(x=>x.id===mid);
    const battingFirstId = (tossOpt==='bat') ? tossWinnerId : (m.teamA===tossWinnerId ? m.teamB : m.teamA);
    const battingTeam = t.teams.find(x=>x.id===battingFirstId);
    const bowlingTeam = t.teams.find(x=>x.id=== (battingFirstId===m.teamA ? m.teamB : m.teamA));
    if(!battingTeam || !bowlingTeam) return alert('Teams not found or have no players');

    // build options for opening batsmen and bowler
    const batOpts = battingTeam.players.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    const bowlOpts = bowlingTeam.players.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    showModal(`<h3>Choose Opening Players</h3>
      <label>Batsman 1</label><select id="openB1">${batOpts}</select>
      <label>Batsman 2</label><select id="openB2">${batOpts}</select>
      <label>Bowler</label><select id="openBow">${bowlOpts}</select>
      <div style="margin-top:10px"><button id="applyOpen" class="btn primary">Start Match</button></div>`);
    document.getElementById('applyOpen').addEventListener('click', ()=>{
      const b1 = document.getElementById('openB1').value;
      const b2 = document.getElementById('openB2').value;
      const bow = document.getElementById('openBow').value;
      if(b1===b2) return alert('Select two different opening batsmen');
      hideModal();
      // init runtime
      initMatchRuntime(tid, mid, tossWinnerId, tossOpt, battingFirstId, b1, b2, bow);
    }, {once:true});
  }

  // ---------- Initialize runtime scoring object ----------
  function initMatchRuntime(tid, mid, tossWinnerId, tossOpt, battingFirstId, b1, b2, bowId){
    const t = data.tournaments.find(x=>x.id===tid);
    const m = t.matches.find(x=>x.id===mid);
    // create runtime object similar to earlier design
    const battingSide = battingFirstId;
    const bowlingSide = (battingSide===m.teamA) ? m.teamB : m.teamA;
    // prepare stats keyed by player id
    const allPlayers = {};
    t.teams.forEach(team=>{
      team.players.forEach(p=>{
        allPlayers[p.id] = { name: p.name, teamId: team.id };
      });
    });
    const batsmenStats = {};
    const bowlerStats = {};
    Object.keys(allPlayers).forEach(pid=>{
      batsmenStats[pid] = { runs:0, balls:0, fours:0, sixes:0, status:'not out' };
      bowlerStats[pid] = { balls:0, runs:0, wkts:0, recent:[] };
    });

    const runtime = {
      matchId: mid, tournamentId: tid,
      oversPerInnings: m.overs,
      innings: 1,
      battingSide: battingSide,
      bowlingSide: bowlingSide,
      score: 0, wickets: 0, balls: 0, oversComplete: 0,
      batsmenStats, bowlerStats,
      striker: b1, nonStriker: b2,
      nextBatsmanPoolIndex: 0, // we will derive pool by team order excluding openers
      currentBowler: bowId,
      firstInningsScore: null,
      finished: false,
      toss: { winner: tossWinnerId, opt: tossOpt },
      commentary: []
    };

    // set nextBatsmanPoolIndex to first player in batting team not equal b1/b2 and not out
    const batTeam = t.teams.find(x=>x.id===battingSide);
    let poolIndex = 0;
    while(poolIndex < batTeam.players.length && (batTeam.players[poolIndex].id === b1 || batTeam.players[poolIndex].id === b2)) poolIndex++;
    runtime.nextBatsmanPoolIndex = poolIndex;

    // save runtime on match
    m.runtime = runtime;
    saveData();

    // set active and show scoring view
    activeMatchRuntime = runtime;
    historyStack = [];
    openScoringView();
    pushCommentary(`Toss: ${getTeamNameByPlayerId(tid, runtime.toss.winner)} won and chose to ${runtime.toss.opt}`);
    updateAllUI();
  }

  // helper get team name by player id (or team id)
  function getTeamNameByPlayerId(tid, idOrTeamId){
    const t = data.tournaments.find(x=>x.id===tid);
    if(!t) return '';
    const teamById = t.teams.find(team=>team.id===idOrTeamId);
    if(teamById) return teamById.name;
    // else try player id
    for(const team of t.teams){
      const p = team.players.find(x=>x.id===idOrTeamId);
      if(p) return team.name;
    }
    return '';
  }

  function openScoringView(){
    // switch to scoring page
    showView('scoring');
  }

  // ---------- Scoring controls ----------
  function pushHistory(action){
    // store deep copy of runtime for undo
    if(!activeMatchRuntime) return;
    historyStack.push(JSON.stringify(activeMatchRuntime));
    if(historyStack.length>120) historyStack.shift();
  }
  function undo(){
    if(historyStack.length===0){ alert('Nothing to undo'); return; }
    const raw = historyStack.pop();
    activeMatchRuntime = JSON.parse(raw);
    // update stored runtime of match in data
    const t = data.tournaments.find(x=>x.id===activeMatchRuntime.tournamentId);
    const m = t.matches.find(x=>x.id===activeMatchRuntime.matchId);
    m.runtime = activeMatchRuntime;
    saveData();
    updateAllUI();
  }

  // run buttons
  runBtns.forEach(b=> b.addEventListener('click', ()=> {
    const r = parseInt(b.dataset.run);
    addRun(r);
  }));
  extraBtns.forEach(b=> b.addEventListener('click', ()=> {
    const type = b.dataset.extra;
    addExtraPrompt(type);
  }));
  undoBtn.addEventListener('click', undo);
  wicketBtn.addEventListener('click', ()=> showWicketModal());
  changeBowlerBtn.addEventListener('click', ()=> showBowlerModal());

  function addRun(r){
    if(!activeMatchRuntime || activeMatchRuntime.finished) return;
    pushHistory({type:'run',val:r});
    const rt = activeMatchRuntime;
    rt.score += r;
    rt.batsmenStats[rt.striker].runs += r;
    rt.batsmenStats[rt.striker].balls += 1;
    if(r===4) rt.batsmenStats[rt.striker].fours += 1;
    if(r===6) rt.batsmenStats[rt.striker].sixes += 1;
    // update bowler
    rt.bowlerStats[rt.currentBowler].runs += r;
    rt.bowlerStats[rt.currentBowler].balls += 1;
    rt.bowlerStats[rt.currentBowler].recent = addRecent(rt.bowlerStats[rt.currentBowler].recent, r);
    rt.balls += 1;
    rt.commentary.push(`${r} run(s)`);
    // rotate strike on odd runs
    if(r % 2 === 1) [rt.striker, rt.nonStriker] = [rt.nonStriker, rt.striker];
    checkEndOfOverOrInnings();
    persistRuntime();
    updateAllUI();
  }

  function addDot(){
    if(!activeMatchRuntime || activeMatchRuntime.finished) return;
    pushHistory({type:'dot'});
    const rt = activeMatchRuntime;
    rt.balls += 1;
    rt.bowlerStats[rt.currentBowler].balls += 1;
    rt.bowlerStats[rt.currentBowler].recent = addRecent(rt.bowlerStats[rt.currentBowler].recent, 0);
    rt.commentary.push('Dot ball');
    checkEndOfOverOrInnings();
    persistRuntime();
    updateAllUI();
  }

  function addExtraPrompt(type){
    if(!activeMatchRuntime || activeMatchRuntime.finished) return;
    // prompt details depending on type
    if(type==='wd'){
      const by = parseInt(prompt('Extra BY runs in addition to wide (0-6)?', '0')) || 0;
      addExtra('wide', by);
    } else if(type==='nb'){
      const bat = parseInt(prompt('Batsman runs on no-ball (0-6)?', '0')) || 0;
      const by = parseInt(prompt('By/legby extras (0-6)?', '0')) || 0;
      addNoBall(bat, by);
    } else if(type==='bye' || type==='lbye'){
      const by = parseInt(prompt('Bye / Leg-bye runs (0-6)?', '0')) || 0;
      addExtra(type, by);
    }
  }

  function addExtra(kind, by){
    pushHistory({type:'extra', kind, by});
    const rt = activeMatchRuntime;
    const extraRuns = (kind==='wide' ? 1 + (by||0) : (by||0));
    rt.score += extraRuns;
    // extras added to bowler runs
    rt.bowlerStats[rt.currentBowler].runs += extraRuns;
    rt.bowlerStats[rt.currentBowler].recent = addRecent(rt.bowlerStats[rt.currentBowler].recent, kind==='wide' ? 'wd' : (kind==='bye'?'b':'lb'));
    rt.commentary.push(`${kind.toUpperCase()} +${by||0}`);
    // Note: wide/no-ball do NOT count as legal ball (except we might give batsman runs for nb)
    if(kind==='wide') { /* do not increase balls */ }
    persistRuntime();
    updateAllUI();
  }

  function addNoBall(batRuns, by){
    pushHistory({type:'nb', bat:batRuns, by});
    const rt = activeMatchRuntime;
    rt.score += 1 + (batRuns||0) + (by||0);
    rt.batsmenStats[rt.striker].runs += (batRuns||0);
    if((batRuns||0) > 0) rt.batsmenStats[rt.striker].balls += 1; // optional: some scorers don't count nb as ball for batsman; keep as earlier logic
    rt.bowlerStats[rt.currentBowler].runs += 1 + (batRuns||0) + (by||0);
    rt.bowlerStats[rt.currentBowler].recent = addRecent(rt.bowlerStats[rt.currentBowler].recent, 'nb');
    rt.commentary.push(`No-ball: bat ${batRuns||0}, by ${by||0}`);
    persistRuntime();
    updateAllUI();
  }

  function addWicket(type, fielderId){
    if(!activeMatchRuntime || activeMatchRuntime.finished) return;
    pushHistory({type:'wicket', wtype:type, fielder: fielderId});
    const rt = activeMatchRuntime;
    rt.wickets += 1;
    rt.batsmenStats[rt.striker].balls += 1;
    rt.batsmenStats[rt.striker].status = 'out ('+type+(fielderId? ' by '+getPlayerNameById(rt.tournamentId, fielderId):'') +')';
    if(type==='bowled' || type==='caught' || type==='stumped'){ rt.bowlerStats[rt.currentBowler].wkts += 1; rt.bowlerStats[rt.currentBowler].balls += 1; }
    else { rt.bowlerStats[rt.currentBowler].balls += 1; }
    rt.bowlerStats[rt.currentBowler].recent = addRecent(rt.bowlerStats[rt.currentBowler].recent, 'W');
    rt.balls += 1;
    rt.commentary.push(`WICKET: ${type}${fielderId? ' by '+ getPlayerNameById(rt.tournamentId,fielderId):''}`);
    // show next batsman selector
    setTimeout(()=> showNextBatsmanModal(), 200);
    persistRuntime();
    updateAllUI();
  }

  function showWicketModal(){
    if(!activeMatchRuntime) return;
    const t = data.tournaments.find(x=>x.id===activeMatchRuntime.tournamentId);
    const bowlTeam = t.teams.find(x=>x.id===activeMatchRuntime.bowlingSide);
    const fielderOpts = bowlTeam.players.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    showModal(`<h3>Wicket</h3>
      <div><label>Type</label><select id="wType"><option value="bowled">Bowled</option><option value="caught">Caught</option><option value="runout">Run Out</option><option value="stumped">Stumped</option><option value="obstruction">Rule Out</option></select></div>
      <div id="fielderRow" style="display:none"><label>Fielder</label><select id="fielderSelect">${fielderOpts}</select></div>
      <div style="margin-top:10px"><button id="applyW" class="btn primary">Apply</button></div>`);
    document.getElementById('wType').addEventListener('change', function(){
      const v = this.value;
      document.getElementById('fielderRow').style.display = (v==='caught' || v==='runout' || v==='stumped') ? 'block' : 'none';
    });
    document.getElementById('applyW').addEventListener('click', ()=>{
      const type = document.getElementById('wType').value;
      const f = document.getElementById('fielderSelect') ? document.getElementById('fielderSelect').value : null;
      hideModal();
      addWicket(type, f);
    }, {once:true});
  }

  function showNextBatsmanModal(){
    const rt = activeMatchRuntime;
    const t = data.tournaments.find(x=>x.id===rt.tournamentId);
    const battingTeam = t.teams.find(x=>x.id===rt.battingSide);
    // remaining players who are not out and not currently batting
    const remaining = battingTeam.players.filter(p=> rt.batsmenStats[p.id].status !== 'out' && p.id !== rt.striker && p.id !== rt.nonStriker);
    if(remaining.length===0){
      // all out
      checkEndOfOverOrInnings(true);
      return;
    }
    const opts = remaining.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    showModal(`<h3>Select Next Batsman</h3>
      <div><select id="nextB">${opts}</select></div>
      <div style="margin-top:8px"><label>Place at:</label><select id="pos"><option value="strike">On strike</option><option value="non">Non strike</option></select></div>
      <div style="margin-top:10px"><button id="setBat" class="btn primary">Set</button></div>`);
    document.getElementById('setBat').addEventListener('click', ()=>{
      const name = document.getElementById('nextB').value;
      const pos = document.getElementById('pos').value;
      // set batsman
      if(pos==='strike') rt.striker = name; else rt.nonStriker = name;
      rt.batsmenStats[name].status = 'not out';
      hideModal();
      persistRuntime();
      updateAllUI();
    }, {once:true});
  }

  function showBowlerModal(){
    const rt = activeMatchRuntime;
    const t = data.tournaments.find(x=>x.id===rt.tournamentId);
    const bowlTeam = t.teams.find(x=>x.id===rt.bowlingSide);
    const opts = bowlTeam.players.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    showModal(`<h3>Select Next Bowler</h3><div><select id="nextBow">${opts}</select></div><div style="margin-top:10px"><button id="setBow" class="btn primary">Set</button></div>`);
    document.getElementById('setBow').addEventListener('click', ()=>{
      const nb = document.getElementById('nextBow').value;
      rt.currentBowler = nb;
      hideModal();
      persistRuntime();
      updateAllUI();
    }, {once:true});
  }

  function addRecent(arr, val){
    arr = arr || [];
    arr.unshift(val);
    if(arr.length>8) arr.pop();
    return arr;
  }

  // ---------- End of over / innings ----------
  function checkEndOfOverOrInnings(forceEnd=false){
    const rt = activeMatchRuntime;
    if(!rt) return;
    if(rt.balls % 6 === 0 || forceEnd){
      rt.oversComplete = Math.floor(rt.balls/6);
      // swap striker at end of over
      [rt.striker, rt.nonStriker] = [rt.nonStriker, rt.striker];
      // check innings end
      const t = data.tournaments.find(x=>x.id===rt.tournamentId);
      const battingTeam = t.teams.find(x=>x.id===rt.battingSide);
      if(rt.oversComplete >= rt.oversPerInnings || rt.wickets >= battingTeam.players.length - 1 || forceEnd){
        endInnings();
      } else {
        // prompt next bowler
        setTimeout(()=> showBowlerModal(), 200);
      }
    }
  }

  function endInnings(){
    const rt = activeMatchRuntime;
    if(rt.innings === 1){
      rt.firstInningsScore = {score: rt.score, wickets: rt.wickets, overs: `${Math.floor(rt.balls/6)}.${rt.balls%6}`};
      rt.innings = 2;
      // swap batting/ bowling sides
      const prevBat = rt.battingSide;
      rt.battingSide = rt.bowlingSide;
      rt.bowlingSide = prevBat;
      // reset counters
      rt.score = 0; rt.wickets = 0; rt.balls = 0; rt.oversComplete = 0;
      // choose opening for 2nd innings: show opening selector again
      // find match in data to get players
      const t = data.tournaments.find(x=>x.id===rt.tournamentId);
      const m = t.matches.find(x=>x.id===rt.matchId);
      // show modal for opening selection for 2nd innings
      showOpeningSelector(rt.tournamentId, rt.matchId, rt.toss.winner, rt.toss.opt); // this will re-init striker/nonStriker
      pushCommentary(`Innings over. Target ${rt.firstInningsScore.score + 1}`);
    } else {
      // match finished
      rt.finished = true;
      const target = rt.firstInningsScore.score + 1;
      let result = '';
      if(rt.score >= target){
        result = `${getTeamNameByPlayerId(rt.tournamentId, rt.battingSide)} won by ${ (getTeamPlayersCount(rt.tournamentId, rt.battingSide) - rt.wickets) } wickets`;
      } else {
        result = `${getTeamNameByPlayerId(rt.tournamentId, (rt.battingSide==='teamA'?'teamB':'teamA'))} won by ${rt.firstInningsScore.score - rt.score} runs`;
      }
      pushCommentary('Match finished: ' + result);
      alert('Match finished: ' + result);
    }
  }

  function getTeamPlayersCount(tid, teamId){
    const t = data.tournaments.find(x=>x.id===tid);
    const team = t.teams.find(x=>x.id===teamId);
    return team ? team.players.length : 0;
  }

  function pushCommentary(text){
    if(!activeMatchRuntime) return;
    activeMatchRuntime.commentary.push(text);
    if(activeMatchRuntime.commentary.length>500) activeMatchRuntime.commentary.shift();
    persistRuntime();
  }

  function persistRuntime(){
    if(!activeMatchRuntime) return;
    // write runtime back to match data
    const t = data.tournaments.find(x=>x.id===activeMatchRuntime.tournamentId);
    const m = t.matches.find(x=>x.id===activeMatchRuntime.matchId);
    m.runtime = activeMatchRuntime;
    saveData();
  }

  // ---------- UI update ----------
  function updateAllUI(){
    if(!activeMatchRuntime) { // clear scoring UI
      matchHeadline.innerText = 'No match';
      tossInfo.innerText = 'Toss: -';
      liveScore.innerText = '0/0';
      oversText.innerText = '0.0';
      strikeNameEl.innerText = '-';
      nonStrikeNameEl.innerText = '-';
      bowlerNameEl.innerText = '-';
      recentBallsEl.innerHTML = '';
      scoreLineEls.commuter = '';
      return;
    }
    const rt = activeMatchRuntime;
    const t = data.tournaments.find(x=>x.id===rt.tournamentId);
    const m = t.matches.find(x=>x.id===rt.matchId);
    // headline
    const teamA = t.teams.find(x=>x.id===m.teamA);
    const teamB = t.teams.find(x=>x.id===m.teamB);
    matchHeadline.innerText = `${teamA.name} vs ${teamB.name} • Innings ${rt.innings}`;
    tossInfo.innerText = `Toss: ${getTeamNameByPlayerId(rt.tournamentId, rt.toss.winner)} won and chose to ${rt.toss.opt}`;
    teamShort.innerText = getTeamNameByPlayerId(rt.tournamentId, rt.battingSide).slice(0,3).toUpperCase();
    liveScore.innerText = `${rt.score}/${rt.wickets}`;
    oversText.innerText = `${Math.floor(rt.balls/6)}.${rt.balls%6} overs of ${rt.oversPerInnings}`;
    targetText.innerText = rt.innings===2 && rt.firstInningsScore ? `Target: ${rt.firstInningsScore.score+1}` : '';
    // need text
    if(rt.innings===2 && rt.firstInningsScore){
      const target = rt.firstInningsScore.score + 1;
      const ballsLeft = rt.oversPerInnings*6 - rt.balls;
      const need = Math.max(0, target - rt.score);
      needText.innerText = `${getTeamNameByPlayerId(rt.tournamentId, rt.battingSide)} need ${need} runs in ${ballsLeft} balls`;
    } else needText.innerText = '';

    // batsman/bowler names & their stats
    strikeNameEl.innerText = getPlayerNameById(rt.tournamentId, rt.striker) || '-';
    nonStrikeNameEl.innerText = getPlayerNameById(rt.tournamentId, rt.nonStriker) || '-';
    bowlerNameEl.innerText = getPlayerNameById(rt.tournamentId, rt.currentBowler) || '-';

    // recent balls from current bowler
    const recent = rt.currentBowler ? rt.bowlerStats[rt.currentBowler].recent || [] : [];
    recentBallsEl.innerHTML = recent.map(x=>`<div class="ball">${escapeHtml(String(x))}</div>`).join('');

    // score line
    scoreLineEls.shortTeam.innerText = getTeamNameByPlayerId(rt.tournamentId, rt.battingSide).slice(0,3).toUpperCase();
    scoreLineEls.scoreLine.innerText = `${rt.score}/${rt.wickets}`;
    scoreLineEls.batLine.innerText = `${getPlayerNameById(rt.tournamentId, rt.striker) || '-'} *`;
    const s = rt.batsmenStats[rt.striker] || {runs:0,balls:0};
    scoreLineEls.batR.innerText = s.runs; scoreLineEls.batB.innerText = s.balls;
    scoreLineEls.bowLine.innerText = getPlayerNameById(rt.tournamentId, rt.currentBowler) || '-';
    const b = rt.currentBowler ? rt.bowlerStats[rt.currentBowler] : {runs:0,wkts:0,balls:0};
    scoreLineEls.bowRW.innerText = `${b.runs}/${b.wkts}`; scoreLineEls.bowO.innerText = `${Math.floor(b.balls/6)}.${b.balls%6}`;

    // bowling table
    scoreLineEls.bowlingTable.innerHTML = '';
    const bowlTeam = t.teams.find(x=>x.id===rt.bowlingSide);
    if(bowlTeam){
      bowlTeam.players.forEach(pl=>{
        const bx = rt.bowlerStats[pl.id] || {balls:0,runs:0,wkts:0};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(pl.name)}</td><td>${Math.floor(bx.balls/6)}.${bx.balls%6}</td><td>${bx.runs}</td><td>${bx.wkts}</td>`;
        scoreLineEls.bowlingTable.appendChild(tr);
      });
    }

    // commentary
    scoreLineEls.commBox.innerText = rt.commentary.join('\\n');
  }

  // helpers
  function getPlayerNameById(tid, pid){
    const t = data.tournaments.find(x=>x.id===tid);
    if(!t) return '';
    for(const team of t.teams){
      const p = team.players.find(x=>x.id===pid);
      if(p) return p.name;
    }
    return '';
  }

  function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ---------- Modal helpers ----------
  const modalOverlay = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  function showModal(html){
    modalContent.innerHTML = html;
    modalOverlay.style.display = 'flex';
  }
  function hideModal(){
    modalOverlay.style.display = 'none';
    modalContent.innerHTML = '';
  }
  window.showModal = showModal; window.hideModal = hideModal;

  // ---------- Utility: open match detail (view existing runtime) ----------
  window.openMatch = function(tid, mid){
    const t = data.tournaments.find(x=>x.id===tid);
    const m = t.matches.find(x=>x.id===mid);
    if(m.runtime){
      activeMatchRuntime = m.runtime;
      historyStack = [];
      openScoringView();
      updateAllUI();
    } else {
      alert('Match not started yet. Click Start to begin scoring.');
    }
  };

  // ---------- UI init ----------
  // populate existing items
  function init(){
    renderTournamentList();
    populateMatchTournamentSelect();
    // default populate team selects for first tournament
    if(data.tournaments.length>0){
      matchTournamentSelect.value = data.tournaments[0].id;
      populateTeamSelects(matchTournamentSelect.value);
    }
    renderMatchList();
    // nav handlers
    navBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        navBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        // also ensure appropriate data lists updated
        if(b.dataset.view==='tournaments' && currentTournamentId){
          const t = data.tournaments.find(x=>x.id===currentTournamentId);
          if(t) renderTeamList(t);
        }
        if(b.dataset.view==='matches') renderMatchList();
        showView(b.dataset.view);
      });
    });
    // tabs
    tabs.forEach(btn=> btn.addEventListener('click', ()=>{
      tabs.forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const name = btn.dataset.tab;
      Object.keys(tabMap).forEach(k=> tabMap[k].style.display = (k===name?'block':'none'));
    }));
    // initial view
    showView('home');
    // run 1 default: attach dot ball quick handler by long-press? For now leave run=0 button as dot if needed.
    // addDot to 0 button as optional
    document.querySelectorAll('.runBtn').forEach(b=> {
      if(b.dataset.run === '0'){ b.addEventListener('dblclick', ()=> addDot()); } // dblclick 0 to mark dot (optional)
    });
  }

  // ---------- Small helpers to expose for testing ----------
  window.addRun = addRun;
  window.addDot = addDot;
  window.addWicket = addWicket;
  window.undoAction = undo;

  // start
  init();

  // ---------- simple cleanup/save on unload ----------
  window.addEventListener('beforeunload', ()=> saveData());

})();
</script>
</body>
</html>
